<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>SequencePaxos - The OmniPaxos Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="A User Guide, Manual, and Tutorial for the OmniPaxos library.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
                <!-- MathJax -->
        <script async type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "ayu" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../foreword.html">Foreword</a></li><li class="chapter-item expanded affix "><a href="../getting-started.html">Getting Started</a></li><li class="chapter-item expanded "><a href="../introduction/index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../sequencepaxos/index.html" class="active"><strong aria-hidden="true">2.</strong> SequencePaxos</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../sequencepaxos/communication.html"><strong aria-hidden="true">2.1.</strong> Communication</a></li><li class="chapter-item expanded "><a href="../sequencepaxos/log.html"><strong aria-hidden="true">2.2.</strong> Reading and Writing</a></li><li class="chapter-item expanded "><a href="../sequencepaxos/compaction.html"><strong aria-hidden="true">2.3.</strong> Compaction</a></li><li class="chapter-item expanded "><a href="../sequencepaxos/reconfiguration.html"><strong aria-hidden="true">2.4.</strong> Reconfiguration</a></li><li class="chapter-item expanded "><a href="../sequencepaxos/logging.html"><strong aria-hidden="true">2.5.</strong> Logging</a></li></ol></li><li class="chapter-item expanded "><a href="../ble/index.html"><strong aria-hidden="true">3.</strong> Ballot Leader Election</a></li><li class="chapter-item expanded "><a href="../runtime/index.html"><strong aria-hidden="true">4.</strong> Runtime</a></li><li class="chapter-item expanded affix "><a href="../project.html">Project Info</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">The OmniPaxos Book</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/haraldng/omnipaxos" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="sequencepaxos"><a class="header" href="#sequencepaxos">SequencePaxos</a></h1>
<p>Each server in the cluster should have a local instance of the  <code>SequencePaxos</code> struct. <code>SequencePaxos</code> maintains a local state of the replicated log, handles incoming messages and produces outgoing messages that the user has to fetch and send using their network implementation. The users also accesses the replicated log via <code>SequencePaxos</code>.</p>
<h2 id="example-key-value-store"><a class="header" href="#example-key-value-store">Example: Key-Value store</a></h2>
<p>As a guide for this tutorial, we will use OmniPaxos to implement a replicated log for the purpose of a consistent Key-Value store. </p>
<p>We begin by defining the type that we want our log entries to consist of:</p>
<pre><code class="language-rust edition2018 no_run noplaypen">#[derive(Clone, Debug)] // Clone and Debug are required traits.
pub struct KeyValue {
    pub key: String,
    pub value: u64,
}
</code></pre>
<h2 id="storage"><a class="header" href="#storage">Storage</a></h2>
<p>You are free to use any storage implementation with <code>SequencePaxos</code>. The only requirement is that it implements the <code>Storage</code> trait. OmniPaxos provides an in-memory storage implementation <code>MemoryStorage</code> which we will use in our example.
For simplicity, we leave out some parts of the implementation for now (such as <a href="../compaction.html">Snapshots</a>).</p>
<pre><code class="language-rust edition2018 no_run noplaypen">    // from the module storage::memory_storage
    #[derive(Clone)]
    pub struct MemoryStorage&lt;T, S&gt;
    where
        T: Entry,
        S: Snapshot&lt;T&gt;,
    {
        /// Vector which contains all the replicated entries in-memory.
        log: Vec&lt;T&gt;,
        /// Last promised round.
        n_prom: Ballot,
        /// Last accepted round.
        acc_round: Ballot,
        /// Length of the decided log.
        ld: u64,
        ...
    }

    impl&lt;T, S&gt; Storage&lt;T, S&gt; for MemoryStorage&lt;T, S&gt;
    where
        T: Entry,
        S: Snapshot&lt;T&gt;,
    {
        fn append_entry(&amp;mut self, entry: T) -&gt; u64 {
            self.log.push(entry);
            self.get_log_len()
        }

        fn append_entries(&amp;mut self, entries: Vec&lt;T&gt;) -&gt; u64 {
            let mut e = entries;
            self.log.append(&amp;mut e);
            self.get_log_len()
        }

        fn append_on_prefix(&amp;mut self, from_idx: u64, entries: Vec&lt;T&gt;) -&gt; u64 {
            self.log.truncate(from_idx as usize);
            self.append_entries(entries)
        }

        fn set_promise(&amp;mut self, n_prom: Ballot) {
            self.n_prom = n_prom;
        }

        fn set_decided_idx(&amp;mut self, ld: u64) {
            self.ld = ld;
        }

        fn get_decided_idx(&amp;self) -&gt; u64 {
            self.ld
        }

        fn set_accepted_round(&amp;mut self, na: Ballot) {
            self.acc_round = na;
        }

        fn get_accepted_round(&amp;self) -&gt; Ballot {
            self.acc_round
        }

        fn get_entries(&amp;self, from: u64, to: u64) -&gt; &amp;[T] {
            self.log.get(from as usize..to as usize).unwrap_or(&amp;[])
        }

        fn get_log_len(&amp;self) -&gt; u64 {
            self.log.len() as u64
        }

        fn get_suffix(&amp;self, from: u64) -&gt; &amp;[T] {
            match self.log.get(from as usize..) {
                Some(s) =&gt; s,
                None =&gt; &amp;[],
            }
        }

        fn get_promise(&amp;self) -&gt; Ballot {
            self.n_prom
        }
        
        ...
    }
</code></pre>
<h2 id="creating-a-node"><a class="header" href="#creating-a-node">Creating a Node</a></h2>
<p>With the structs for log entry and storage defined, we can now go ahead and create our <code>SequencePaxos</code> replica instance.  Letâ€™s assume we want our KV-store to be replicated on three servers. On, say node 2, we would do the following: </p>
<pre><code class="language-rust edition2018 no_run noplaypen">use omnipaxos_core::{
    sequence_paxos::{SequencePaxos, SequencePaxosConfig},
    storage::{memory_storage::MemoryStorage},
};

// configuration with id 1 and the following cluster
let configuration_id = 1;
let _cluster = vec![1, 2, 3];

// create the replica 2 in this cluster (other replica instances are created similarly with pid 1 and 3 on the other nodes)
let my_pid = 2;
let my_peers = vec![1, 3];

let mut sp_config = SequencePaxosConfig::default();
sp_config.set_configuration_id(configuration_id);
sp_config.set_pid(my_pid);
sp_config.set_peers(my_peers);

let storage = MemoryStorage::&lt;KeyValue, ())&gt;::default();
let mut sp = SequencePaxos::with(sp_config, storage);
</code></pre>
<p>For convenience, <code>SequencePaxosConfig</code> also features a constructor <code>SequencePaxosConfig::with_hocon()</code> that loads the values using <a href="https://vleue.com/hocon.rs/hocon/index.html">hocon</a>. One could then instead have the parameters in a file <code>config/node2.conf</code></p>
<pre><code class="language-json">{
    config_id: 1,
    pid: 2,
    log_file_path: &quot;/sequencepaxos/logs&quot;
}
</code></pre>
<p>This can then be loaded to construct <code>SequencePaxosConfig</code>:</p>
<pre><code class="language-rust edition2018 no_run noplaypen">let raw_cfg = HoconLoader::new()
    .load_file(&quot;tests/config/node2.conf&quot;)
    .expect(&quot;Failed to load hocon file&quot;)
    .hocon()
    .unwrap();

let sp_config = SequencePaxosConfig::with_hocon(cfg);
</code></pre>
<h2 id="crash-recovery"><a class="header" href="#crash-recovery">Crash-recovery</a></h2>
<p>To support crash-recovery, we have to make sure that our storage implementation persisted the values. Then upon recovery, we have to make sure that our <code>SequencePaxos</code> will be started with the previously persisted state. To do so, create <code>SequencePaxos</code> as earlier described but use the persisted state as the <code>storage</code> argument. Then, call <code>fail_recovery()</code> to correctly initialize the volatile state.</p>
<pre><code class="language-rust edition2018 no_run noplaypen">/* Restarting our node after a crash... */
let recovered_storage = ...;    // the recovered persistent state.
let mut recovered_paxos = SequencePaxos::with(sp_config, recovered_storage);
recovered_paxos.fail_recovery();
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../introduction/index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../sequencepaxos/communication.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../introduction/index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../sequencepaxos/communication.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
